name: Build and release v8

on: workflow_dispatch

jobs:
  build_macos_arm64:
    name: macOS
    runs-on: macos-14

    steps:
    - name: Install Depot Tools
      uses: newkdev/setup-depot-tools@v1.0.1
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11.7'
    - name: Set up
      run: mkdir v8 && cd v8
    - run: |
        echo 'solutions = [
        {
          "name": "v8",
          "url": "https://github.com/openwebf/v8.git",
          "deps_file": "DEPS",
          "managed": False,
          "custom_deps": {}
        },
        ]' > .gclient
    - run: cat .gclient
    - run: ls -la
    - run: gclient sync && cd v8
    - name: Generate build dir
      run: ./tools/dev/v8gen.py arm64.release -vv
    - run: rm ./out/arm64.release/args.gn
    - name: Set Args Config
      run: cp .github/macos-arm64/args.gn ./out/arm64.release/args.gn
    - name: Setup Ninja
      uses: ashutoshvarma/setup-ninja@master
      with:
        version: 1.10.0
    - name: Build
      run: ninja -C ./out/arm64.release
    - uses: actions/upload-artifact@v2
      with:
        name: v8_macos_arm64
        path: out/arm64.release/
