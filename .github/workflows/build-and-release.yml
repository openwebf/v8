name: Build and release v8

on: workflow_dispatch

jobs:
  build_macos_arm64:
    name: macOS
    runs-on: macos-14

    steps:
    - name: Install Depot Tools
      uses: newkdev/setup-depot-tools@v1.0.1
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11.7'
    - run: |
        echo 'solutions = [
        {
          "name": "v8",
          "url": "https://github.com/openwebf/v8.git",
          "deps_file": "DEPS",
          "managed": False,
          "custom_deps": {}
        },
        ]' > .gclient
    - run: cat .gclient
    - run: ls -la
    - run: gclient sync && cd v8
    - name: Generate build dir
      run: cd v8 && ./tools/dev/v8gen.py arm64.release -vv
    - run: cd v8 && rm ./out.gn/arm64.release/args.gn
    - run: |
      echo 'is_component_build = true
          is_debug = false
          target_cpu = "arm64"
          v8_target_cpu = "arm64"
          use_goma = false
          v8_enable_backtrace = true
          v8_enable_i18n_support = false
          v8_use_zlib = false
          v8_enable_webassembly = false
          v8_enable_disassembler = false
          v8_enable_object_print = false
          v8_enable_verify_heap = false
          dcheck_always_on = false' > v8/out.gn/arm64.release/args.gn
    - run: cat v8/out.gn/arm64.release/args.gn
    - name: Setup Ninja
      uses: ashutoshvarma/setup-ninja@master
      with:
        version: 1.10.0
    - name: Build
      run: ninja -C ./v8/out.gn/arm64.release
    - uses: actions/upload-artifact@v2
      with:
        name: v8_macos_arm64
        path: v8/out.gn/arm64.release/
